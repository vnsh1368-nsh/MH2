<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <title>مدیریت هزینه های زوجین - نسخه اصلاح‌شده</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: Tahoma, sans-serif; direction: rtl; background: #f8f9fa; margin: 0; padding: 20px; }
    h2 { color: #333; }
    .container { max-width: 900px; margin: auto; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    input, select, button { padding: 8px; margin: 5px 0; border-radius: 8px; border: 1px solid #ccc; width: 100%; box-sizing: border-box; }
    button { cursor: pointer; font-weight: bold; }
    .add-btn { background: #28a745; color: #fff; }
    .add-btn[disabled] { opacity: 0.7; cursor: default; }
    .print-btn { background: #007bff; color: #fff; margin-top: 10px; }
    .clear-btn { background: #dc3545; color: #fff; margin-top: 10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background: #f1f1f1; }
    .chart-container { margin-top: 20px; }
    canvas { max-width: 100%; height: 300px; }
    .totals { margin-top: 15px; padding: 10px; background: #f9f9f9; border-radius: 8px; }
    .small { font-size: 0.9rem; color: #666; margin-top: 6px; }
    footer { text-align:center; margin-top:12px; color:#666; font-size:0.85rem;}
  </style>
</head>
<body>
  <div class="container">
    <h2>برنامه مدیریت هزینه ماهانه — نسخه اصلاح‌شده</h2>

    <label>نام شخص اول:</label>
    <input type="text" id="person1" placeholder="نام شخص اول را وارد کنید">

    <label>نام شخص دوم:</label>
    <input type="text" id="person2" placeholder="نام شخص دوم را وارد کنید">

    <label>انتخاب ماه:</label>
    <select id="month">
      <option value="فروردین">فروردین</option>
      <option value="اردیبهشت">اردیبهشت</option>
      <option value="خرداد">خرداد</option>
      <option value="تیر">تیر</option>
      <option value="مرداد">مرداد</option>
      <option value="شهریور">شهریور</option>
      <option value="مهر">مهر</option>
      <option value="آبان">آبان</option>
      <option value="آذر">آذر</option>
      <option value="دی">دی</option>
      <option value="بهمن">بهمن</option>
      <option value="اسفند">اسفند</option>
    </select>

    <label>انتخاب شخص:</label>
    <select id="person">
      <option value="1">شخص اول</option>
      <option value="2">شخص دوم</option>
    </select>

    <label>مبلغ هزینه:</label>
    <input type="text" id="amount" placeholder="مثال: 250000">

    <label>شرح هزینه:</label>
    <input type="text" id="desc" placeholder="مثال: خرید مواد غذایی">

    <button id="addBtn" class="add-btn" onclick="addExpense()">➕ افزودن هزینه</button>
    <div class="small">راهنما: علامت‌های جداکننده هزارگان (، , یا فاصله) حذف می‌شوند؛ می‌توانید از ارقام فارسی هم استفاده کنید.</div>

    <table id="expenseTable" aria-live="polite">
      <thead>
        <tr>
          <th>ماه</th>
          <th>نام شخص</th>
          <th>مبلغ</th>
          <th>شرح هزینه</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="totals">
      <h3 id="total"></h3>
      <p id="totalP1"></p>
      <p id="totalP2"></p>
    </div>

    <div class="chart-container">
      <canvas id="expenseChart"></canvas>
    </div>

    <button class="print-btn" onclick="window.print()">🖨 چاپ فاکتور</button>
    <button class="clear-btn" onclick="clearData()">🗑 پاک کردن همه اطلاعات</button>

    <footer>برای دیباگ: کنسول مرورگر (Developer Console) را باز کنید — لاگ‌ها آنجا نمایش داده می‌شوند.</footer>
  </div>

  <!-- Chart.js (global) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Firebase (Module) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getDatabase, ref, push, set, onValue, remove } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

    // ---------- پیکربندی Firebase (از مقادیر شما) ----------
    const firebaseConfig = {
      apiKey: "AIzaSyDScr34NkC6QO_fAj5hfM0mm-ryGJpu7lI",
      authDomain: "modh-81612.firebaseapp.com",
      databaseURL: "https://modh-81612-default-rtdb.firebaseio.com",
      projectId: "modh-81612",
      storageBucket: "modh-81612.firebasestorage.app",
      messagingSenderId: "1016905860913",
      appId: "1:1016905860913:web:a4441ae5aba3d69a611210",
      measurementId: "G-J96S76RT7H"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ---------- متغیرها ----------
    let expenses = [];

    // ---------- تبدیل ارقام فارسی به لاتین و حذف علامت‌های جداکننده ----------
    function normalizeNumberInput(s) {
      if (!s && s !== 0) return "";
      s = String(s);
      // تبدیل ارقام فارسی
      const pers = { '۰':'0','۱':'1','۲':'2','۳':'3','۴':'4','۵':'5','۶':'6','۷':'7','۸':'8','۹':'9' };
      s = s.replace(/[۰-۹]/g, d => pers[d] || d);
      // حذف کاما، فاصله و علامت‌های هزارگان فارسی
      s = s.replace(/[,٬\s]/g, '');
      return s;
    }

    // ---------- افزودن هزینه (با async/await و مدیریت خطا) ----------
    window.addExpense = async function() {
      try {
        const addBtn = document.getElementById("addBtn");
        addBtn.disabled = true;

        const p1 = document.getElementById("person1").value.trim();
        const p2 = document.getElementById("person2").value.trim();
        const person = document.getElementById("person").value;
        const month = document.getElementById("month").value;
        const rawAmount = document.getElementById("amount").value.trim();
        const desc = document.getElementById("desc").value.trim();

        if (!p1 || !p2) { alert("لطفاً نام هر دو شخص را وارد کنید"); addBtn.disabled = false; return; }

        const cleaned = normalizeNumberInput(rawAmount);
        const amount = Number(cleaned);

        if (!cleaned || isNaN(amount) || amount <= 0) {
          alert("لطفاً یک مبلغ معتبر وارد کنید (مثال: 250000)");
          addBtn.disabled = false;
          return;
        }
        if (!desc) { alert("لطفاً شرح هزینه را وارد کنید"); addBtn.disabled = false; return; }

        const name = (person === "1") ? p1 : p2;

        // ساخت مرجع جدید و ذخیره
        const newRef = push(ref(db, "expenses"));
        await set(newRef, { month, name, amount, desc, createdAt: Date.now() });

        console.log("Saved:", { month, name, amount, desc });

        // پاک کردن فیلدها (نام‌ها حفظ می‌شوند)
        document.getElementById("amount").value = "";
        document.getElementById("desc").value = "";
        addBtn.disabled = false;

        // فوکوس روی مبلغ برای ورود سریع
        document.getElementById("amount").focus();
      } catch (err) {
        console.error("Error in addExpense:", err);
        alert("خطا هنگام ذخیره‌سازی. کنسول را بررسی کنید.");
        document.getElementById("addBtn").disabled = false;
      }
    };

    // ---------- رندر جدول ----------
    function renderTable() {
      const tbody = document.querySelector("#expenseTable tbody");
      tbody.innerHTML = "";
      let total = 0;

      const p1 = document.getElementById("person1").value.trim();
      const p2 = document.getElementById("person2").value.trim();
      let totalP1 = 0;
      let totalP2 = 0;

      // مرتب‌سازی بر اساس زمان (قدیمی‌تر اول)
      const sorted = expenses.slice().sort((a,b) => (a.createdAt||0) - (b.createdAt||0));

      sorted.forEach(exp => {
        const row = `<tr>
          <td>${exp.month || ''}</td>
          <td>${exp.name || ''}</td>
          <td>${Number(exp.amount).toLocaleString()} تومان</td>
          <td>${exp.desc || ''}</td>
        </tr>`;
        tbody.innerHTML += row;
        total += Number(exp.amount) || 0;

        if (exp.name === p1) totalP1 += Number(exp.amount) || 0;
        if (exp.name === p2) totalP2 += Number(exp.amount) || 0;
      });

      document.getElementById("total").innerText = "🔹 مجموع کل هزینه‌ها: " + total.toLocaleString() + " تومان";
      document.getElementById("totalP1").innerText = p1 ? `➡️ مجموع هزینه‌های ${p1}: ${totalP1.toLocaleString()} تومان` : "";
      document.getElementById("totalP2").innerText = p2 ? `➡️ مجموع هزینه‌های ${p2}: ${totalP2.toLocaleString()} تومان` : "";

      updateChart();
    }

    // ---------- نمودار ----------
    let myChart = null;
    function updateChart() {
      const names = [...new Set(expenses.map(e => e.name || ''))];
      const sums = names.map(n => expenses.filter(e => e.name === n).reduce((s, e) => s + Number(e.amount || 0), 0));

      const ctx = document.getElementById("expenseChart").getContext("2d");
      if (myChart) myChart.destroy();
      myChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: names,
          datasets: [{
            label: "مجموع هزینه‌ها",
            data: sums
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false
        }
      });
    }

    // ---------- پاک کردن همه داده‌ها ----------
    window.clearData = function() {
      if (confirm("آیا مطمئن هستید که همه اطلاعات حذف شود؟")) {
        remove(ref(db, "expenses"))
          .then(() => console.log("All expenses removed"))
          .catch(err => { console.error("Remove error:", err); alert("خطا در حذف داده‌ها، کنسول را بررسی کنید."); });
      }
    };

    // ---------- Listener Realtime ----------
    onValue(ref(db, "expenses"), snapshot => {
      if (!snapshot.exists()) {
        expenses = [];
        renderTable();
        console.log("No expenses in DB (yet).");
        return;
      }
      expenses = [];
      snapshot.forEach(child => {
        const val = child.val();
        val._key = child.key;
        if (!val.createdAt) val.createdAt = 0;
        expenses.push(val);
      });
      console.log("Expenses updated (count):", expenses.length);
      renderTable();
    }, error => {
      console.error("onValue error:", error);
    });

    console.log("Firebase Realtime listener set.");
  </script>
</body>
</html>
