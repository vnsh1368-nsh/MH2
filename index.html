<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <title>Ù…Ø¯ÛŒØ±ÛŒØª Ù‡Ø²ÛŒÙ†Ù‡ Ù‡Ø§ÛŒ Ø²ÙˆØ¬ÛŒÙ† - Ù†Ø³Ø®Ù‡ Ø§ØµÙ„Ø§Ø­â€ŒØ´Ø¯Ù‡</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: Tahoma, sans-serif; direction: rtl; background: #f8f9fa; margin: 0; padding: 20px; }
    h2 { color: #333; }
    .container { max-width: 900px; margin: auto; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    input, select, button { padding: 8px; margin: 5px 0; border-radius: 8px; border: 1px solid #ccc; width: 100%; box-sizing: border-box; }
    button { cursor: pointer; font-weight: bold; }
    .add-btn { background: #28a745; color: #fff; }
    .add-btn[disabled] { opacity: 0.7; cursor: default; }
    .print-btn { background: #007bff; color: #fff; margin-top: 10px; }
    .clear-btn { background: #dc3545; color: #fff; margin-top: 10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background: #f1f1f1; }
    .chart-container { margin-top: 20px; }
    canvas { max-width: 100%; height: 300px; }
    .totals { margin-top: 15px; padding: 10px; background: #f9f9f9; border-radius: 8px; }
    .small { font-size: 0.9rem; color: #666; margin-top: 6px; }
    footer { text-align:center; margin-top:12px; color:#666; font-size:0.85rem;}
  </style>
</head>
<body>
  <div class="container">
    <h2>Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù…Ø¯ÛŒØ±ÛŒØª Ù‡Ø²ÛŒÙ†Ù‡ Ù…Ø§Ù‡Ø§Ù†Ù‡ â€” Ù†Ø³Ø®Ù‡ Ø§ØµÙ„Ø§Ø­â€ŒØ´Ø¯Ù‡</h2>

    <label>Ù†Ø§Ù… Ø´Ø®Øµ Ø§ÙˆÙ„:</label>
    <input type="text" id="person1" placeholder="Ù†Ø§Ù… Ø´Ø®Øµ Ø§ÙˆÙ„ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">

    <label>Ù†Ø§Ù… Ø´Ø®Øµ Ø¯ÙˆÙ…:</label>
    <input type="text" id="person2" placeholder="Ù†Ø§Ù… Ø´Ø®Øµ Ø¯ÙˆÙ… Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">

    <label>Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø§Ù‡:</label>
    <select id="month">
      <option value="ÙØ±ÙˆØ±Ø¯ÛŒÙ†">ÙØ±ÙˆØ±Ø¯ÛŒÙ†</option>
      <option value="Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª">Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª</option>
      <option value="Ø®Ø±Ø¯Ø§Ø¯">Ø®Ø±Ø¯Ø§Ø¯</option>
      <option value="ØªÛŒØ±">ØªÛŒØ±</option>
      <option value="Ù…Ø±Ø¯Ø§Ø¯">Ù…Ø±Ø¯Ø§Ø¯</option>
      <option value="Ø´Ù‡Ø±ÛŒÙˆØ±">Ø´Ù‡Ø±ÛŒÙˆØ±</option>
      <option value="Ù…Ù‡Ø±">Ù…Ù‡Ø±</option>
      <option value="Ø¢Ø¨Ø§Ù†">Ø¢Ø¨Ø§Ù†</option>
      <option value="Ø¢Ø°Ø±">Ø¢Ø°Ø±</option>
      <option value="Ø¯ÛŒ">Ø¯ÛŒ</option>
      <option value="Ø¨Ù‡Ù…Ù†">Ø¨Ù‡Ù…Ù†</option>
      <option value="Ø§Ø³ÙÙ†Ø¯">Ø§Ø³ÙÙ†Ø¯</option>
    </select>

    <label>Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø®Øµ:</label>
    <select id="person">
      <option value="1">Ø´Ø®Øµ Ø§ÙˆÙ„</option>
      <option value="2">Ø´Ø®Øµ Ø¯ÙˆÙ…</option>
    </select>

    <label>Ù…Ø¨Ù„Øº Ù‡Ø²ÛŒÙ†Ù‡:</label>
    <input type="text" id="amount" placeholder="Ù…Ø«Ø§Ù„: 250000">

    <label>Ø´Ø±Ø­ Ù‡Ø²ÛŒÙ†Ù‡:</label>
    <input type="text" id="desc" placeholder="Ù…Ø«Ø§Ù„: Ø®Ø±ÛŒØ¯ Ù…ÙˆØ§Ø¯ ØºØ°Ø§ÛŒÛŒ">

    <button id="addBtn" class="add-btn" onclick="addExpense()">â• Ø§ÙØ²ÙˆØ¯Ù† Ù‡Ø²ÛŒÙ†Ù‡</button>
    <div class="small">Ø±Ø§Ù‡Ù†Ù…Ø§: Ø¹Ù„Ø§Ù…Øªâ€ŒÙ‡Ø§ÛŒ Ø¬Ø¯Ø§Ú©Ù†Ù†Ø¯Ù‡ Ù‡Ø²Ø§Ø±Ú¯Ø§Ù† (ØŒ , ÛŒØ§ ÙØ§ØµÙ„Ù‡) Ø­Ø°Ù Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯Ø› Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§Ø² Ø§Ø±Ù‚Ø§Ù… ÙØ§Ø±Ø³ÛŒ Ù‡Ù… Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.</div>

    <table id="expenseTable" aria-live="polite">
      <thead>
        <tr>
          <th>Ù…Ø§Ù‡</th>
          <th>Ù†Ø§Ù… Ø´Ø®Øµ</th>
          <th>Ù…Ø¨Ù„Øº</th>
          <th>Ø´Ø±Ø­ Ù‡Ø²ÛŒÙ†Ù‡</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="totals">
      <h3 id="total"></h3>
      <p id="totalP1"></p>
      <p id="totalP2"></p>
    </div>

    <div class="chart-container">
      <canvas id="expenseChart"></canvas>
    </div>

    <button class="print-btn" onclick="window.print()">ğŸ–¨ Ú†Ø§Ù¾ ÙØ§Ú©ØªÙˆØ±</button>
    <button class="clear-btn" onclick="clearData()">ğŸ—‘ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª</button>

    <footer>Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¨Ø§Ú¯: Ú©Ù†Ø³ÙˆÙ„ Ù…Ø±ÙˆØ±Ú¯Ø± (Developer Console) Ø±Ø§ Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯ â€” Ù„Ø§Ú¯â€ŒÙ‡Ø§ Ø¢Ù†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.</footer>
  </div>

  <!-- Chart.js (global) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Firebase (Module) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getDatabase, ref, push, set, onValue, remove } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

    // ---------- Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Firebase (Ø§Ø² Ù…Ù‚Ø§Ø¯ÛŒØ± Ø´Ù…Ø§) ----------
    const firebaseConfig = {
      apiKey: "AIzaSyDScr34NkC6QO_fAj5hfM0mm-ryGJpu7lI",
      authDomain: "modh-81612.firebaseapp.com",
      databaseURL: "https://modh-81612-default-rtdb.firebaseio.com",
      projectId: "modh-81612",
      storageBucket: "modh-81612.firebasestorage.app",
      messagingSenderId: "1016905860913",
      appId: "1:1016905860913:web:a4441ae5aba3d69a611210",
      measurementId: "G-J96S76RT7H"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ---------- Ù…ØªØºÛŒØ±Ù‡Ø§ ----------
    let expenses = [];

    // ---------- ØªØ¨Ø¯ÛŒÙ„ Ø§Ø±Ù‚Ø§Ù… ÙØ§Ø±Ø³ÛŒ Ø¨Ù‡ Ù„Ø§ØªÛŒÙ† Ùˆ Ø­Ø°Ù Ø¹Ù„Ø§Ù…Øªâ€ŒÙ‡Ø§ÛŒ Ø¬Ø¯Ø§Ú©Ù†Ù†Ø¯Ù‡ ----------
    function normalizeNumberInput(s) {
      if (!s && s !== 0) return "";
      s = String(s);
      // ØªØ¨Ø¯ÛŒÙ„ Ø§Ø±Ù‚Ø§Ù… ÙØ§Ø±Ø³ÛŒ
      const pers = { 'Û°':'0','Û±':'1','Û²':'2','Û³':'3','Û´':'4','Ûµ':'5','Û¶':'6','Û·':'7','Û¸':'8','Û¹':'9' };
      s = s.replace(/[Û°-Û¹]/g, d => pers[d] || d);
      // Ø­Ø°Ù Ú©Ø§Ù…Ø§ØŒ ÙØ§ØµÙ„Ù‡ Ùˆ Ø¹Ù„Ø§Ù…Øªâ€ŒÙ‡Ø§ÛŒ Ù‡Ø²Ø§Ø±Ú¯Ø§Ù† ÙØ§Ø±Ø³ÛŒ
      s = s.replace(/[,Ù¬\s]/g, '');
      return s;
    }

    // ---------- Ø§ÙØ²ÙˆØ¯Ù† Ù‡Ø²ÛŒÙ†Ù‡ (Ø¨Ø§ async/await Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§) ----------
    window.addExpense = async function() {
      try {
        const addBtn = document.getElementById("addBtn");
        addBtn.disabled = true;

        const p1 = document.getElementById("person1").value.trim();
        const p2 = document.getElementById("person2").value.trim();
        const person = document.getElementById("person").value;
        const month = document.getElementById("month").value;
        const rawAmount = document.getElementById("amount").value.trim();
        const desc = document.getElementById("desc").value.trim();

        if (!p1 || !p2) { alert("Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ù‡Ø± Ø¯Ùˆ Ø´Ø®Øµ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯"); addBtn.disabled = false; return; }

        const cleaned = normalizeNumberInput(rawAmount);
        const amount = Number(cleaned);

        if (!cleaned || isNaN(amount) || amount <= 0) {
          alert("Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ù…Ø¨Ù„Øº Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ø§Ù„: 250000)");
          addBtn.disabled = false;
          return;
        }
        if (!desc) { alert("Ù„Ø·ÙØ§Ù‹ Ø´Ø±Ø­ Ù‡Ø²ÛŒÙ†Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯"); addBtn.disabled = false; return; }

        const name = (person === "1") ? p1 : p2;

        // Ø³Ø§Ø®Øª Ù…Ø±Ø¬Ø¹ Ø¬Ø¯ÛŒØ¯ Ùˆ Ø°Ø®ÛŒØ±Ù‡
        const newRef = push(ref(db, "expenses"));
        await set(newRef, { month, name, amount, desc, createdAt: Date.now() });

        console.log("Saved:", { month, name, amount, desc });

        // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙÛŒÙ„Ø¯Ù‡Ø§ (Ù†Ø§Ù…â€ŒÙ‡Ø§ Ø­ÙØ¸ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯)
        document.getElementById("amount").value = "";
        document.getElementById("desc").value = "";
        addBtn.disabled = false;

        // ÙÙˆÚ©ÙˆØ³ Ø±ÙˆÛŒ Ù…Ø¨Ù„Øº Ø¨Ø±Ø§ÛŒ ÙˆØ±ÙˆØ¯ Ø³Ø±ÛŒØ¹
        document.getElementById("amount").focus();
      } catch (err) {
        console.error("Error in addExpense:", err);
        alert("Ø®Ø·Ø§ Ù‡Ù†Ú¯Ø§Ù… Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ. Ú©Ù†Ø³ÙˆÙ„ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.");
        document.getElementById("addBtn").disabled = false;
      }
    };

    // ---------- Ø±Ù†Ø¯Ø± Ø¬Ø¯ÙˆÙ„ ----------
    function renderTable() {
      const tbody = document.querySelector("#expenseTable tbody");
      tbody.innerHTML = "";
      let total = 0;

      const p1 = document.getElementById("person1").value.trim();
      const p2 = document.getElementById("person2").value.trim();
      let totalP1 = 0;
      let totalP2 = 0;

      // Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø²Ù…Ø§Ù† (Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØªØ± Ø§ÙˆÙ„)
      const sorted = expenses.slice().sort((a,b) => (a.createdAt||0) - (b.createdAt||0));

      sorted.forEach(exp => {
        const row = `<tr>
          <td>${exp.month || ''}</td>
          <td>${exp.name || ''}</td>
          <td>${Number(exp.amount).toLocaleString()} ØªÙˆÙ…Ø§Ù†</td>
          <td>${exp.desc || ''}</td>
        </tr>`;
        tbody.innerHTML += row;
        total += Number(exp.amount) || 0;

        if (exp.name === p1) totalP1 += Number(exp.amount) || 0;
        if (exp.name === p2) totalP2 += Number(exp.amount) || 0;
      });

      document.getElementById("total").innerText = "ğŸ”¹ Ù…Ø¬Ù…ÙˆØ¹ Ú©Ù„ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§: " + total.toLocaleString() + " ØªÙˆÙ…Ø§Ù†";
      document.getElementById("totalP1").innerText = p1 ? `â¡ï¸ Ù…Ø¬Ù…ÙˆØ¹ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ ${p1}: ${totalP1.toLocaleString()} ØªÙˆÙ…Ø§Ù†` : "";
      document.getElementById("totalP2").innerText = p2 ? `â¡ï¸ Ù…Ø¬Ù…ÙˆØ¹ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ ${p2}: ${totalP2.toLocaleString()} ØªÙˆÙ…Ø§Ù†` : "";

      updateChart();
    }

    // ---------- Ù†Ù…ÙˆØ¯Ø§Ø± ----------
    let myChart = null;
    function updateChart() {
      const names = [...new Set(expenses.map(e => e.name || ''))];
      const sums = names.map(n => expenses.filter(e => e.name === n).reduce((s, e) => s + Number(e.amount || 0), 0));

      const ctx = document.getElementById("expenseChart").getContext("2d");
      if (myChart) myChart.destroy();
      myChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: names,
          datasets: [{
            label: "Ù…Ø¬Ù…ÙˆØ¹ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§",
            data: sums
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false
        }
      });
    }

    // ---------- Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ ----------
    window.clearData = function() {
      if (confirm("Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù‡Ù…Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø­Ø°Ù Ø´ÙˆØ¯ØŸ")) {
        remove(ref(db, "expenses"))
          .then(() => console.log("All expenses removed"))
          .catch(err => { console.error("Remove error:", err); alert("Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ØŒ Ú©Ù†Ø³ÙˆÙ„ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯."); });
      }
    };

    // ---------- Listener Realtime ----------
    onValue(ref(db, "expenses"), snapshot => {
      if (!snapshot.exists()) {
        expenses = [];
        renderTable();
        console.log("No expenses in DB (yet).");
        return;
      }
      expenses = [];
      snapshot.forEach(child => {
        const val = child.val();
        val._key = child.key;
        if (!val.createdAt) val.createdAt = 0;
        expenses.push(val);
      });
      console.log("Expenses updated (count):", expenses.length);
      renderTable();
    }, error => {
      console.error("onValue error:", error);
    });

    console.log("Firebase Realtime listener set.");
  </script>
</body>
</html>
